machine:
  xcode:
    version: 9.2.0

dependencies:
  pre:
    - brew update
    - brew uninstall python
    - brew install https://raw.githubusercontent.com/Homebrew/homebrew-core/f2a764ef944b1080be64bd88dca9a1d80130c558/Formula/python.rb
    - brew install python@2
    - brew install wget cmake cppcheck tinyxml eigen pcre poco
    # install dependencies for Fast-RTPS if you are using it
    - brew install asio tinyxml2
    - python3 -m pip install catkin_pkg empy pyparsing pyyaml setuptools argcomplete colcon-common-extensions
    - mkdir -p ~/ros2_install && cd ~/ros2_install && wget https://github.com/ros2/ros2/releases/download/release-bouncy/ros2-bouncy-macos-x86_64.tar.bz2 && tar xf ros2-bouncy-macos-x86_64.tar.bz2
    - wget -qO- https://raw.githubusercontent.com/creationix/nvm/v0.33.11/install.sh | bash
    - nvm install v8.11.3
    - nvm alias default v8.11.3

  override:
    - node --version && npm --version && rm -rf ./node_modules/
    - source ~/ros2_install/ros2-osx/local_setup.bash && git submodule init && git submodule update && npm install --python=python2.7
    - export PATH="/usr/local/opt/python@2/libexec/bin:$PATH" && npm run lint

test:
  override:
    - npm install istanbul coveralls
    - source ~/ros2_install/ros2-osx/local_setup.bash && node scripts/compile_cpp.js && node ./node_modules/.bin/istanbul cover ./scripts/run_test.js --report lcovonly && cat ./coverage/lcov.info | ./node_modules/coveralls/bin/coveralls.js && rm -rf ./coverage
